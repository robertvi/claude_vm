##
## Restrictive Tinyproxy Configuration for Claude Code Container
## This configuration allows only essential domains for Claude API and common package managers
##

User nobody
Group nogroup

# Bind to all interfaces so container can access it
# Only accept connections from localhost and container network
Bind 0.0.0.0
Port 8888

# Timeout: If no data is received or sent for this amount of time, close connection
Timeout 600

# ErrorFile: Defines the HTML file to send when a given HTTP error occurs
DefaultErrorFile "/usr/share/tinyproxy/default.html"

# StatFile: HTML file to serve for stat host requests
StatFile "/usr/share/tinyproxy/stats.html"

# LogFile: path to log file
LogFile "/var/log/tinyproxy/tinyproxy.log"

# LogLevel: Set the logging level
# Critical (least verbose), Error, Warning, Notice, Connect (to log connections), Info
LogLevel Info

# PidFile: Write the PID to this file
PidFile "/run/tinyproxy/tinyproxy.pid"

# MaxClients: Maximum number of client connections
MaxClients 100

# MinSpareServers/MaxSpareServers: Minimum/Maximum number of spare servers to keep
MinSpareServers 5
MaxSpareServers 20

# StartServers: Number of servers to start initially
StartServers 10

# MaxRequestsPerChild: Maximum number of requests handled by a child process
MaxRequestsPerChild 0

# Allow: Access control list
# Allow connections from localhost and Docker/Podman bridge network
Allow 127.0.0.1
Allow ::1
Allow 10.0.0.0/8
Allow 172.16.0.0/12
Allow 192.168.0.0/16

# ViaProxyName: Via hostname to use
ViaProxyName "tinyproxy"

# DisableViaHeader: Don't send the Via header
#DisableViaHeader Yes

# Filter: Enable filtering
#Filter "/etc/tinyproxy/filter"

# FilterURLs: Filter based on URLs rather than domains
#FilterURLs On

# FilterExtended: Use POSIX Extended regular expressions
#FilterExtended On

# FilterCaseSensitive: Case sensitive filtering
#FilterCaseSensitive On

# FilterDefaultDeny: Default action for filtering (Yes = deny all except allowed)
#FilterDefaultDeny Yes

# Anonymous: Remove headers for privacy
#Anonymous "Host"
#Anonymous "Authorization"

# ConnectPort: Ports allowed for CONNECT method (for HTTPS)
# Allow standard HTTPS port
ConnectPort 443
ConnectPort 563

# ReversePath: Enable reverse proxy (not needed for forward proxy)
#ReversePath "/example/" "http://www.example.com/"

##
## RESTRICTIVE MODE: Only allow specific domains required for Claude Code
##

# Claude API
Upstream api.anthropic.com:443

# NPM package registries
Upstream registry.npmjs.org:443
Upstream registry.yarnpkg.com:443

# Python package index
Upstream pypi.org:443
Upstream files.pythonhosted.org:443

# Git repositories
Upstream github.com:443
Upstream gitlab.com:443
Upstream objects.githubusercontent.com:443
Upstream raw.githubusercontent.com:443

# Common CDNs for packages
Upstream cdn.jsdelivr.net:443
Upstream unpkg.com:443

# Note: The Upstream directive in tinyproxy is actually for chaining proxies.
# For domain whitelisting, we need to use a different approach.
# Let me correct this configuration to use proper filtering.

##
## Domain Filtering via Connect method restriction
##
## Since tinyproxy doesn't have built-in domain whitelisting for CONNECT,
## we'll need to use the filtering mechanism with a custom filter file.
## See host/filter for the allowed domains list.
##

# Enable URL filtering
Filter "/etc/tinyproxy/filter"
FilterURLs On
FilterExtended On
FilterDefaultDeny Yes
